<div class="p-4 shadow-md bg-white rounded-lg">
	<div class="flex items-center gap-3 mb-4">
		<button (click)="goBack()" type="button" class="p-5 ">
      <i class="fa fa-arrow-left cursor-pointer hover:text-blue-500"></i>
    </button>
		<h2 class="text-xl font-semibold align-center grow text-center">Add Expense</h2>
	</div>

	<form [formGroup]="form" (ngSubmit)="save()" class="space-y-4">
		<div>
			<label class="block text-sm font-medium mb-2">Categories</label>
			<select formControlName="category" class="w-full rounded-lg bg-gray-100 p-3">
				<option value="" disabled selected>Select category</option>
				@for (c of categories(); track $index) {
					<option [value]="c.id">{{ c.label }}</option>
				}
			</select>
			@if (form.get('category')?.invalid && form.get('category')?.touched) {
				<div class="text-xs text-red-500 mt-1">Category is required.</div>
			}
		</div>

		<div>
			<label class="block text-sm font-medium mb-2">Amount</label>
			<input formControlName="amount" type="number" step="0.01" placeholder="50.00" class="w-full rounded-lg bg-gray-100 p-3" />
			@if (form.get('amount')?.invalid && form.get('amount')?.touched) {
				<div class="text-xs text-red-500 mt-1">
					@if (form.get('amount')?.errors?.['required']) { Amount is required. }
					@if (form.get('amount')?.errors?.['min']) { Amount must be greater than 0. }
				</div>
			}
			<!-- Live conversion preview -->
			@if (convertedAmount() && conversionRate()) {
				<div class="text-xs text-green-600 mt-2">
					â‰ˆ ${{ convertedAmount() }} USD (Rate: {{ conversionRate() }})
				</div>
			}
		</div>

		<div>
			<label class="block text-sm font-medium mb-2">Date</label>
			<div class="relative flex items-center bg-gray-100 rounded-lg p-3">
				<input formControlName="date" type="date" class="flex-1 bg-transparent outline-none border-none text-gray-700" />
			</div>
			@if (form.get('date')?.invalid && form.get('date')?.touched) {
				<div class="text-xs text-red-500 mt-1">Date is required.</div>
			}
		</div>

		<div>
			<label class="block text-sm font-medium mb-2">Currency</label>
			<select formControlName="currency" class="w-full rounded-lg bg-gray-100 p-3">
				<option value="" disabled>Select currency</option>
				@for (c of currencies(); track $index) {
					<option [value]="c">{{ c }}</option>
				}
			</select>
			@if (form.get('currency')?.invalid && form.get('currency')?.touched) {
				<div class="text-xs text-red-500 mt-1">Currency is required.</div>
			}
		</div>

		<div>
			<label class="block text-sm font-medium mb-2">Attach Receipt</label>
			
			<!-- Receipt preview -->
			@if (receiptPreview()) {
				<div class="mb-3 relative">
					<img [src]="receiptPreview()" class="w-full max-h-48 object-cover rounded-lg border-2 border-blue-200" alt="Receipt preview" />
					<button 
						(click)="removeReceipt()" 
						type="button" 
						class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600"
					>
						<i class="fas fa-times"></i>
					</button>
					<div class="text-xs text-gray-500 mt-1">{{ receiptFileName() }}</div>
				</div>
			}
			
			<div class="relative flex items-center bg-gray-100 rounded-lg p-3">
				<input (change)="onFileChange($event)" type="file" accept="image/*" class="hidden" id="receipt-input" />
				<label for="receipt-input" class="flex-1 text-gray-500 cursor-pointer">
					{{ receiptPreview() ? 'Change image' : 'Upload image (max 5MB)' }}
				</label>
				<label for="receipt-input" class="ml-2 text-lg text-gray-400 cursor-pointer"><i class="fa fa-camera"></i></label>
			</div>
		</div>

		<div class="mb-3">
			<h3 class="font-medium mb-2">Categories</h3>
			<div class="grid grid-cols-4 gap-3">
				@for (c of categories(); track $index) {
					<button type="button"
						(click)="chooseCategory(c.id)"
						[class.border-2]="selectedCategory() === c.id"
						[class.border-blue-600]="selectedCategory() === c.id"
						class="flex flex-col items-center p-3 rounded-lg bg-white shadow-sm">
						<div
							class="w-10 h-10 rounded-full flex items-center justify-center mb-2"
							[ngStyle]="{
								'background': selectedCategory() === c.id ? '#2563eb' : categoryBgColor(c.id),
								'color': selectedCategory() === c.id ? 'white' : categoryIconColor(c.id)
							}"
						>
							<i class="{{c.icon}}"></i>
						</div>
						<div class="text-xs" [ngStyle]="{ 'color': selectedCategory() === c.id ? '#2563eb' : '#222' }">{{ c.label }}</div>
					</button>
				}
				<button type="button" class="flex flex-col items-center p-3 rounded-lg bg-white shadow-sm">
					<div class="w-10 h-10 rounded-full flex items-center justify-center mb-2 border border-blue-400 text-blue-500 bg-white">
						<i class="fas fa-plus"></i>
					</div>
					<div class="text-xs text-blue-500">Add Category</div>
				</button>
			</div>
		</div>

		<div>
			<button 
				type="submit" 
				[disabled]="loading() || form.invalid" 
				class="w-full cursor-pointer bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
			>
				@if (loading()) {
					<span class="flex items-center justify-center gap-2">
						<i class="fas fa-spinner fa-spin"></i>
						Saving...
					</span>
				} @else {
					<span>Save Expense</span>
				}
			</button>
		</div>
	</form>
</div>
